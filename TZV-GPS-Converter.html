<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>TZV GPS Converter</title>
 <style>
     * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
     }

     body {
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         min-height: 100vh;
         display: flex;
         align-items: center;
         justify-content: center;
         padding: 15px;
     }

     .container {
         background: rgba(255, 255, 255, 0.95);
         backdrop-filter: blur(10px);
         border-radius: 20px;
         padding: 15px;
         box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
         max-width: 500px;
         width: 100%;
     }

     @media (min-width: 768px) {
         .container {
             padding: 25px;
             max-width: 600px;
         }
     }

     h1 {
         color: #333;
         text-align: center;
         margin-bottom: 20px;
         font-size: 1.8em;
         font-weight: 600;
     }

     @media (min-width: 768px) {
         h1 {
             margin-bottom: 25px;
             font-size: 2.2em;
         }
     }

     .input-group {
         margin-bottom: 15px;
         transition: all 0.3s ease;
     }

     .input-group.disabled {
         opacity: 0.3;
         pointer-events: none;
         filter: blur(1px);
         transition: all 0.3s ease;
     }

.travel-input-group {
    margin-bottom: 15px;
    padding: 4px 15px 4px 15px;
    background: rgba(40, 167, 69, 0.05);
    border-radius: 12px;
    border: 2px solid rgba(40, 167, 69, 0.2);
}
label {
    display: block;
    margin-bottom: 4px;
    color: #555;
    font-weight: 500;
    font-size: 14px;
}

.travel-label {
    color: #28a745;
    font-weight: 600;
    margin-bottom: -1px;
}

.travel-subtitle {
    font-size: 12px;
    color: #666;
    font-weight: 400;
    margin-top: 1px;
    margin-bottom: 1px;
}

     .what3words-tooltip {
         position: relative;
         cursor: help;
     }

     .what3words-tooltip::after {
         content: "GPS coordinate conversion from What3Words is prone to future errors due to updates on What3Words site.";
         position: absolute;
         bottom: 100%;
         left: 50%;
         transform: translateX(-50%);
         background: #333;
         color: white;
         padding: 8px 12px;
         border-radius: 6px;
         font-size: 12px;
         white-space: nowrap;
         opacity: 0;
         visibility: hidden;
         transition: all 0.3s ease;
         z-index: 1000;
         max-width: 300px;
         white-space: normal;
         text-align: center;
         line-height: 1.4;
     }

     .what3words-tooltip::before {
         content: "";
         position: absolute;
         bottom: 100%;
         left: 50%;
         transform: translateX(-50%);
         border: 6px solid transparent;
         border-top-color: #333;
         opacity: 0;
         visibility: hidden;
         transition: all 0.3s ease;
         z-index: 1000;
         margin-bottom: -6px;
     }

     .what3words-tooltip:hover::after,
     .what3words-tooltip:hover::before {
         opacity: 1;
         visibility: visible;
     }

     @media (min-width: 768px) {
         label {
             font-size: 16px;
         }
     }

     .coordinate-container {
         position: relative;
         border: 2px solid #e0e0e0;
         border-radius: 12px;
         background: white;
         transition: all 0.3s ease;
         overflow: hidden;
     }

     .coordinate-container:focus-within {
         border-color: #667eea;
         box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
     }

     .travel-input-container {
         position: relative;
         border: 2px solid #28a745;
         border-radius: 12px;
         background: white;
         transition: all 0.3s ease;
     }

     .travel-input-container:focus-within {
         border-color: #1e7e34;
         box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
     }

     .coordinate-input {
         width: 100%;
         padding: 12px 16px;
         border: none;
         background: transparent;
         font-size: 16px;
         font-family: monospace;
         font-weight: 600;
         text-align: center;
         letter-spacing: 1px;
         color: #333;
         position: relative;
         z-index: 2;
         white-space: pre-line;
         line-height: 1.4;
         resize: none;
         overflow: hidden;
         height: 60px;
         touch-action: manipulation;
         -webkit-appearance: none;
     }

     .coordinate-input::placeholder {
         color: #ddd;
         opacity: 1.0;
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         font-weight: 400;
         font-size: 14px;
         letter-spacing: normal;
     }

     .what3words-input, .travel-input {
         width: 100%;
         padding: 12px 16px;
         border: none;
         background: transparent;
         font-size: 16px;
         font-weight: 500;
         text-align: center;
         color: #333;
         position: relative;
         z-index: 2;
         touch-action: manipulation;
         -webkit-appearance: none;
     }

     .what3words-input::placeholder {
         color: #ddd;
         opacity: 1.0;
     }

     .travel-input {
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         color: #28a745;
         font-weight: 600;
     }

     .coordinate-input:focus, .what3words-input:focus, .travel-input:focus {
         outline: none;
     }

     .coordinate-labels {
         position: absolute;
         top: 12px;
         left: 16px;
         font-size: 12px;
         font-family: sans-serif;
         color: #bbb;
         pointer-events: none;
         z-index: 1;
         line-height: 1.4;
         font-weight: 400;
     }

     .coordinate-labels .label-line {
         height: 22px;
         display: flex;
         align-items: center;
     }

     .convert-btn {
         width: 100%;
         padding: 16px;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         border: none;
         border-radius: 12px;
         font-size: 16px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s ease;
         margin: 15px 0;
         touch-action: manipulation;
     }

     .convert-btn:hover {
         transform: translateY(-2px);
         box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
     }

     .convert-btn:active {
         transform: translateY(0);
     }

     .results {
         background: #f8f9fa;
         border-radius: 12px;
         padding: 20px;
         margin-top: 20px;
         border-left: 4px solid #667eea;
     }

     .result-item {
         margin-bottom: 15px;
         padding: 15px;
         background: white;
         border-radius: 8px;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
     }

     .result-value {
         color: #666;
         font-family: monospace;
         font-size: 13px;
         word-break: break-all;
         padding: 12px;
         background: #f1f3f4;
         border-radius: 8px;
         transition: background-color 0.2s ease;
         line-height: 1.6;
     }

     .result-value .warning-text {
         word-break: normal !important;
         overflow-wrap: break-word !important;
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
     }

     @media (min-width: 768px) {
         .result-value {
             font-size: 14px;
         }
     }

     .result-value a {
         color: #1976d2;
         text-decoration: none;
         font-weight: 500;
         word-break: break-all;
     }

     .result-value a:hover {
         text-decoration: underline;
         color: #0d47a1;
     }

     .result-value a:visited {
         color: #7b1fa2;
     }

     .result-separator {
         border: none;
         border-top: 1px solid #ddd;
         margin: 15px 0;
     }

     .copy-all-btn {
         width: 100%;
         padding: 12px;
         background: #28a745;
         color: white;
         border: none;
         border-radius: 8px;
         font-size: 14px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s ease;
         margin-top: 15px;
         touch-action: manipulation;
     }

     .copy-all-btn:hover {
         background: #218838;
         transform: translateY(-1px);
     }

     .copy-all-btn:active {
         transform: translateY(0);
     }

     .copy-all-btn.copied {
         background: #17a2b8;
     }

     .email-btn {
         width: 100%;
         padding: 12px;
         background: #007bff;
         color: white;
         border: none;
         border-radius: 8px;
         font-size: 14px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s ease;
         margin-top: 10px;
         touch-action: manipulation;
     }

     .email-btn:hover {
         background: #0056b3;
         transform: translateY(-1px);
     }

     .email-btn:active {
         transform: translateY(0);
     }

     .button-group {
         display: flex;
         flex-direction: column;
         gap: 10px;
         margin-top: 15px;
     }

     @media (min-width: 768px) {
         .button-group {
             flex-direction: row;
             gap: 15px;
         }

         .copy-all-btn,
         .email-btn {
             margin-top: 0;
             flex: 1;
         }
     }

     .error {
         background: #f8d7da;
         color: #721c24;
         padding: 15px;
         border-radius: 8px;
         margin: 15px 0;
         border-left: 4px solid #dc3545;
         font-size: 14px;
     }

     .map-container {
         background: #f8f9fa;
         border-radius: 12px;
         padding: 20px;
         margin-top: 20px;
         border-left: 4px solid #667eea;
     }

     .map-header {
         margin-bottom: 15px;
         font-weight: 500;
         color: #333;
         text-align: center;
     }

     .map-frame {
         width: 100%;
         height: 300px;
         border: none;
         border-radius: 8px;
         background: #e9ecef;
         display: flex;
         align-items: center;
         justify-content: center;
         color: #666;
         font-size: 14px;
     }

     @media (min-width: 768px) {
         .map-frame {
             height: 400px;
         }
     }

     .loading {
         background: #e3f2fd;
         border: 1px solid #bbdefb;
         border-radius: 12px;
         padding: 20px;
         margin-top: 20px;
         color: #0d47a1;
         text-align: center;
         display: none;
     }

     .spinner {
         display: inline-block;
         width: 20px;
         height: 20px;
         border: 3px solid #f3f3f3;
         border-top: 3px solid #667eea;
         border-radius: 50%;
         animation: spin 1s linear infinite;
         margin-right: 10px;
     }

     @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
     }
 </style>
</head>
<body>
 <div class="container">
     <h1>🗺️ TZV GPS Converter</h1>

     <div class="input-group" id="option1-group">
         <label>Option 1: Decimal eg. +143.56189, -35.34123:</label>
         <div class="coordinate-container">
             <textarea class="coordinate-input input-line" id="option1-input" 
                    inputmode="numeric" autocomplete="off" rows="2" 
                    placeholder="Numbers only - no dots or spaces needed"
                    aria-label="Enter longitude and latitude in decimal format"></textarea>
             <div class="coordinate-labels">
                 <div class="label-line">Long</div>
                 <div class="label-line">Lat</div>
             </div>
         </div>
     </div>

     <div class="input-group" id="option2-group">
         <label>Option 2: DMS eg. +146:13:16.0173, -36:27:50.6416:</label>
         <div class="coordinate-container">
             <textarea class="coordinate-input input-line" id="option2-input" 
                    inputmode="numeric" autocomplete="off" rows="2" 
                    placeholder="Numbers only - no dots or spaces needed"
                    aria-label="Enter longitude and latitude in degrees, minutes, seconds format"></textarea>
             <div class="coordinate-labels">
                 <div class="label-line">Long</div>
                 <div class="label-line">Lat</div>
             </div>
         </div>
     </div>

     <div class="input-group what3words-tooltip" id="option3-group">
         <label>Option 3: What3Words eg. nooks.lifts.parole:</label>
         <div class="coordinate-container">
             <input type="text" class="what3words-input" id="what3words-input" 
                    autocomplete="off" placeholder="word.word.word"
                    aria-label="Enter What3Words address">
         </div>
     </div>

     <div class="travel-input-group">
         <label class="travel-label">Travel From (Optional):</label>
         <div class="travel-subtitle">eg. Poowong<br>eg. 5829 Western Hwy, Dadswells Bridge</div>
         <div class="travel-input-container">
             <input type="text" class="travel-input" id="travel-input" 
                    autocomplete="off" placeholder="Enter starting location"
                    aria-label="Enter starting location for directions">
         </div>
     </div>

     <button class="convert-btn" onclick="convertCoordinates()">Convert & Generate Links</button>

     <div id="loading" class="loading">
         <div class="spinner"></div>
         Converting What3Words to decimal coordinates...
     </div>

     <div id="results" class="results" style="display: none;">
         <div class="result-item">
             <div style="margin-bottom: 10px; font-weight: 500; color: #333;">Results:</div>
             <div id="combined-results" class="result-value"></div>
             <div class="button-group">
                 <button class="copy-all-btn" onclick="copyAllText()" id="copy-btn">📋 Copy All</button>
                 <button class="email-btn" onclick="openEmail()" id="email-btn">📧 Send Email</button>
             </div>
         </div>
     </div>

     <div id="map-section" class="map-container" style="display: none;">
         <div class="map-header">📍 Location Map</div>
         <iframe id="map-frame" class="map-frame" src="" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
             Loading map...
         </iframe>
     </div>

     <div id="error" class="error" style="display: none;"></div>
 </div>

 <script>
     // ===== CONFIGURATION AND ERROR MESSAGES =====
     const CONFIG = {
         COORDINATE_PRECISION: 5,
         MAP_ZOOM_LEVEL: 16,
         AUSTRALIA_BOUNDS: {
             LAT_MIN: -55,   // Includes Antarctic territories
             LAT_MAX: -9,    // Northern Australia
             LNG_MIN: 110,   // Western Australia
             LNG_MAX: 160    // Eastern territories
         }
     };

     const ERROR_MESSAGES = {
         NETWORK_ERROR: 'Network connection failed. Please check your internet connection and try again.',
         INVALID_COORDINATES: 'Please enter valid coordinates within Australian territory.',
         COORDINATES_OUT_OF_BOUNDS: 'Coordinates appear to be outside Australian territory. Please check your input.',
         SERVICE_UNAVAILABLE: 'Location service temporarily unavailable. Please try again in a few moments.',
         WHAT3WORDS_INVALID: 'Please enter a valid What3Words address in the format: word.word.word',
         WHAT3WORDS_FORMAT: 'What3Words must contain exactly 3 words separated by dots or spaces.',
         WHAT3WORDS_CHARACTERS: 'What3Words can only contain letters (a-z). Numbers and special characters are not allowed.',
         CONVERSION_FAILED: 'Unable to convert What3Words address. Please verify the address is correct.',
         NO_INPUT: 'Please enter coordinates using any of the three options above.',
         ADDRESS_LOOKUP_FAILED: 'Could not determine address for this location.',
         COPY_FAILED: 'Unable to copy to clipboard. Please select and copy the text manually.',
         EMAIL_FAILED: 'Unable to open email program. Please copy the coordinates manually.'
     };

     // ===== GLOBAL STATE VARIABLES =====
     let option1Data = { lng: '', lat: '' };
     let option2Data = { lng: '', lat: '' };
     let option1Cursor = 'lng';
     let option2Cursor = 'lng';
     let what3wordsData = '';
     let travelFromData = '';

     // ===== COORDINATE VALIDATION FUNCTIONS =====
     function validateAustralianCoordinates(lat, lng) {
         const bounds = CONFIG.AUSTRALIA_BOUNDS;
         
         if (lat < bounds.LAT_MIN || lat > bounds.LAT_MAX) {
             throw new Error(ERROR_MESSAGES.COORDINATES_OUT_OF_BOUNDS + 
                           ` Latitude ${lat.toFixed(2)}° is outside Australian range (${bounds.LAT_MAX}° to ${bounds.LAT_MIN}°).`);
         }
         
         if (lng < bounds.LNG_MIN || lng > bounds.LNG_MAX) {
             throw new Error(ERROR_MESSAGES.COORDINATES_OUT_OF_BOUNDS + 
                           ` Longitude ${lng.toFixed(2)}° is outside Australian range (${bounds.LNG_MIN}° to ${bounds.LNG_MAX}°).`);
         }
         
         return true;
     }

     function validateCoordinateInput(lat, lng) {
         if (isNaN(lat) || isNaN(lng)) {
             throw new Error(ERROR_MESSAGES.INVALID_COORDINATES + ' Please check your number format.');
         }
         
         return validateAustralianCoordinates(lat, lng);
     }

     // ===== DISPLAY UPDATE FUNCTIONS =====
     function updateOption1Display() {
         const input = document.getElementById('option1-input');
         
         let displayValue = '';
         if (option1Data.lng) {
             displayValue += option1Data.lng;
         }
         if (option1Data.lng && option1Data.lat) {
             displayValue += '\n';
         }
         if (option1Data.lat) {
             displayValue += option1Data.lat;
         }
         
         input.value = displayValue;
         input.setSelectionRange(input.value.length, input.value.length);
     }

     function updateOption2Display() {
         const input = document.getElementById('option2-input');
         
         let displayValue = '';
         if (option2Data.lng) {
             displayValue += option2Data.lng;
         }
         if (option2Data.lng && option2Data.lat) {
             displayValue += '\n';
         }
         if (option2Data.lat) {
             displayValue += option2Data.lat;
         }
         
         input.value = displayValue;
         input.setSelectionRange(input.value.length, input.value.length);
     }

     // ===== FIELD ENABLE/DISABLE LOGIC =====
     function checkAndDisableFields() {
         const hasOption1 = option1Data.lng || option1Data.lat;
         const hasOption2 = option2Data.lng || option2Data.lat;
         const hasWhat3Words = what3wordsData.length > 0;
         
         if (hasOption1) {
             document.getElementById('option2-group').classList.add('disabled');
             document.getElementById('option3-group').classList.add('disabled');
         } else if (hasOption2) {
             document.getElementById('option1-group').classList.add('disabled');
             document.getElementById('option3-group').classList.add('disabled');
         } else if (hasWhat3Words) {
             document.getElementById('option1-group').classList.add('disabled');
             document.getElementById('option2-group').classList.add('disabled');
         } else {
             document.getElementById('option1-group').classList.remove('disabled');
             document.getElementById('option2-group').classList.remove('disabled');
             document.getElementById('option3-group').classList.remove('disabled');
         }
     }

     // ===== OPTION 1 INPUT HANDLING (DECIMAL COORDINATES) =====
     document.getElementById('option1-input').addEventListener('input', function(e) {
         let rawValue = e.target.value.replace(/[\n\r,\s]/g, '');
         
         if (rawValue === '') {
             option1Data = { lng: '', lat: '' };
             option1Cursor = 'lng';
             updateOption1Display();
             checkAndDisableFields();
             return;
         }
         
         let value = rawValue.replace(/[^\d]/g, '');
         
         if (value.length <= 7) {
             option1Data.lng = value.length > 0 ? '+' + value.substring(0, 3) + (value.length > 3 ? '.' + value.substring(3) : '') : '';
             option1Data.lat = '';
             option1Cursor = 'lng';
         } else if (value.length === 8 && option1Cursor === 'lng') {
             const lngDigits = value.substring(0, 8);
             option1Data.lng = '+' + lngDigits.substring(0, 3) + '.' + lngDigits.substring(3);
             option1Data.lat = '-';
             option1Cursor = 'lat';
             
             setTimeout(() => {
                 updateOption1Display();
                 const input = document.getElementById('option1-input');
                 const lngLength = option1Data.lng.length;
                 input.setSelectionRange(lngLength + 2, lngLength + 2);
             }, 0);
             return;
         } else if (value.length === 8 && option1Cursor === 'lat') {
             const lngDigits = value.substring(0, 8);
             option1Data.lng = '+' + lngDigits.substring(0, 3) + '.' + lngDigits.substring(3);
             option1Data.lat = '';
             option1Cursor = 'lng';
         } else {
             const lngDigits = value.substring(0, 8);
             const latDigits = value.substring(8, 15);
             
             option1Data.lng = '+' + lngDigits.substring(0, 3) + '.' + lngDigits.substring(3);
             option1Data.lat = '-' + latDigits.substring(0, 2) + (latDigits.length > 2 ? '.' + latDigits.substring(2) : '');
             option1Cursor = 'lat';
         }
         
         updateOption1Display();
         checkAndDisableFields();
     });

     document.getElementById('option1-input').addEventListener('keydown', function(e) {
         if (e.key === 'Enter') {
             if (option1Cursor === 'lat' && (!option1Data.lat || option1Data.lat.length < 10)) {
                 e.preventDefault();
                 return false;
             }
             else if (option1Data.lng && option1Data.lat && option1Data.lng.length >= 10 && option1Data.lat.length >= 10) {
                 e.preventDefault();
                 convertCoordinates();
                 return false;
             }
         }
     });

     // ===== OPTION 2 INPUT HANDLING (DMS COORDINATES) =====
     document.getElementById('option2-input').addEventListener('input', function(e) {
         let rawValue = e.target.value.replace(/[\n\r,\s]/g, '');
         
         if (rawValue === '') {
             option2Data = { lng: '', lat: '' };
             option2Cursor = 'lng';
             updateOption2Display();
             checkAndDisableFields();
             return;
         }
         
         let value = rawValue.replace(/[^\d]/g, '');
         
         if (value.length <= 10) {
             const digits = value;
             option2Data.lng = digits.length > 0 ? '+' + digits.substring(0, 3) + 
                              (digits.length > 3 ? ':' + digits.substring(3, 5) : '') +
                              (digits.length > 5 ? ':' + digits.substring(5, 7) : '') +
                              (digits.length > 7 ? '.' + digits.substring(7) : '') : '';
             option2Data.lat = '';
             option2Cursor = 'lng';
         } else if (value.length === 11 && option2Cursor === 'lng') {
             const lngDigits = value.substring(0, 11);
             option2Data.lng = '+' + lngDigits.substring(0, 3) + ':' + 
                              lngDigits.substring(3, 5) + ':' + 
                              lngDigits.substring(5, 7) + '.' + 
                              lngDigits.substring(7);
             option2Data.lat = '-';
             option2Cursor = 'lat';
             
             setTimeout(() => {
                 updateOption2Display();
                 const input = document.getElementById('option2-input');
                 const lngLength = option2Data.lng.length;
                 input.setSelectionRange(lngLength + 2, lngLength + 2);
             }, 0);
             return;
         } else if (value.length === 11 && option2Cursor === 'lat') {
             const lngDigits = value.substring(0, 11);
             option2Data.lng = '+' + lngDigits.substring(0, 3) + ':' + 
                              lngDigits.substring(3, 5) + ':' + 
                              lngDigits.substring(5, 7) + '.' + 
                              lngDigits.substring(7);
             option2Data.lat = '';
             option2Cursor = 'lng';
         } else {
             const lngDigits = value.substring(0, 11);
             const latDigits = value.substring(11, 21);
             
             option2Data.lng = '+' + lngDigits.substring(0, 3) + ':' + 
                              lngDigits.substring(3, 5) + ':' + 
                              lngDigits.substring(5, 7) + '.' + 
                              lngDigits.substring(7);
             
             option2Data.lat = '-' + latDigits.substring(0, 2) + 
                              (latDigits.length > 2 ? ':' + latDigits.substring(2, 4) : '') +
                              (latDigits.length > 4 ? ':' + latDigits.substring(4, 6) : '') +
                              (latDigits.length > 6 ? '.' + latDigits.substring(6) : '');
             option2Cursor = 'lat';
         }
         
         updateOption2Display();
         checkAndDisableFields();
     });

     document.getElementById('option2-input').addEventListener('keydown', function(e) {
         if (e.key === 'Enter') {
             if (option2Cursor === 'lat' && (!option2Data.lat || option2Data.lat.length < 15)) {
                 e.preventDefault();
                 return false;
             }
             else if (option2Data.lng && option2Data.lat && option2Data.lng.length >= 15 && option2Data.lat.length >= 15) {
                 e.preventDefault();
                 convertCoordinates();
                 return false;
             }
         }
     });

     // ===== WHAT3WORDS INPUT HANDLING =====
     document.getElementById('what3words-input').addEventListener('input', function(e) {
         what3wordsData = e.target.value.trim();
         checkAndDisableFields();
     });

     // ===== TRAVEL INPUT HANDLING =====
     document.getElementById('travel-input').addEventListener('input', function(e) {
         travelFromData = e.target.value.trim();
     });

     // ===== WHAT3WORDS VALIDATION AND CONVERSION =====
     function validateWhat3Words(input) {
         if (!input || input.trim() === '') {
             return { valid: false, error: ERROR_MESSAGES.WHAT3WORDS_INVALID };
         }

         let cleaned = input.trim().toLowerCase();
         cleaned = cleaned.replace(/^\/+/, '');
         
         if (!cleaned.includes('.') && cleaned.includes(' ')) {
             cleaned = cleaned.replace(/\s+/g, '.');
         }
         
         cleaned = cleaned.replace(/[\s.]+/g, '.');
         cleaned = cleaned.replace(/^\.+|\.+$/g, '');
         
         const words = cleaned.split('.');
         if (words.length !== 3) {
             return { 
                 valid: false, 
                 error: ERROR_MESSAGES.WHAT3WORDS_FORMAT
             };
         }
         
         for (let word of words) {
             if (!/^[a-z]+$/.test(word)) {
                 return { 
                     valid: false, 
                     error: ERROR_MESSAGES.WHAT3WORDS_CHARACTERS
                 };
             }
         }

         return { valid: true, cleaned: cleaned };
     }

     function extractCoordinatesFromHTML(html) {
         try {
             const nextDataMatch = html.match(/<script id="__NEXT_DATA__" type="application\/json">(.*?)<\/script>/s);
             
             if (nextDataMatch) {
                 const jsonData = nextDataMatch[1];
                 const data = JSON.parse(jsonData);
                 const location = data.props?.pageProps?.location;
                 
                 if (location?.coordinates) {
                     return {
                         latitude: location.coordinates.lat,
                         longitude: location.coordinates.lng,
                         what3words: location.threeWordAddress,
                         success: true
                     };
                 }
             }
             
             throw new Error('No coordinate data found in page');
             
         } catch (error) {
             throw new Error(`Failed to parse coordinates: ${error.message}`);
         }
     }

     async function convertWhat3WordsToDecimal(what3words) {
         const what3wordsUrl = `https://what3words.com/${what3words}`;
         
         try {
             const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(what3wordsUrl)}`;
             const response = await fetch(proxyUrl);
             
             if (!response.ok) {
                 if (response.status >= 500) {
                     throw new Error(ERROR_MESSAGES.SERVICE_UNAVAILABLE);
                 } else {
                     throw new Error(`${ERROR_MESSAGES.NETWORK_ERROR} (Status: ${response.status})`);
                 }
             }
             
             const data = await response.json();
             
             if (!data.contents) {
                 throw new Error(ERROR_MESSAGES.SERVICE_UNAVAILABLE + ' No content received.');
             }
             
             const result = extractCoordinatesFromHTML(data.contents);
             return result;
             
         } catch (error) {
             if (error.name === 'TypeError') {
                 throw new Error(ERROR_MESSAGES.NETWORK_ERROR);
             }
             throw new Error(ERROR_MESSAGES.CONVERSION_FAILED + ` ${error.message}`);
         }
     }

     // ===== LOADING STATE MANAGEMENT =====
     function showLoading(show) {
         document.getElementById('loading').style.display = show ? 'block' : 'none';
     }

     function showError(message) {
         const errorDiv = document.getElementById('error');
         errorDiv.textContent = message;
         errorDiv.style.display = 'block';
     }

     // ===== COORDINATE PARSING FUNCTIONS =====
     function parseDMS(dmsStr) {
         const parts = dmsStr.replace('-', '').split(':');
         if (parts.length !== 3) return null;
         
         const degrees = parseFloat(parts[0]);
         const minutes = parseFloat(parts[1]);
         const seconds = parseFloat(parts[2]);
         
         return degrees + minutes/60 + seconds/3600;
     }

     // ===== MAIN CONVERSION FUNCTION =====
     document.addEventListener('keypress', function(e) {
         if (e.key === 'Enter') {
             convertCoordinates();
         }
     });

     async function convertCoordinates() {
         const resultsDiv = document.getElementById('results');
         const errorDiv = document.getElementById('error');
         const mapSection = document.getElementById('map-section');
         const loadingDiv = document.getElementById('loading');
         
         resultsDiv.style.display = 'none';
         errorDiv.style.display = 'none';
         mapSection.style.display = 'none';
         loadingDiv.style.display = 'none';
         
         let lat = null, lng = null;
         let what3wordsUrl = null;
         
         try {
             if (option1Data.lng && option1Data.lat) {
                 lng = parseFloat(option1Data.lng.replace(/[^\d.-]/g, ''));
                 lat = parseFloat(option1Data.lat.replace(/[^\d.-]/g, ''));
                 lat = -Math.abs(lat);
                 
                 validateCoordinateInput(lat, lng);
                 
             } else if (option2Data.lng && option2Data.lat) {
                 lng = parseDMS(option2Data.lng);
                 lat = -Math.abs(parseDMS(option2Data.lat.replace('-', '')));
                 
                 validateCoordinateInput(lat, lng);
                 
             } else if (what3wordsData) {
                 const validation = validateWhat3Words(what3wordsData);
                 if (!validation.valid) {
                     showError(validation.error);
                     return;
                 }

                 const cleanWords = validation.cleaned;
                 what3wordsUrl = `https://what3words.com/${cleanWords}`;
                 
                 showLoading(true);
                 
                 try {
                     const w3wResult = await convertWhat3WordsToDecimal(cleanWords);
                     if (w3wResult.success) {
                         lat = w3wResult.latitude;
                         lng = w3wResult.longitude;
                         
                         validateCoordinateInput(lat, lng);
                     } else {
                         showLoading(false);
                         showError(ERROR_MESSAGES.CONVERSION_FAILED);
                         return;
                     }
                 } catch (error) {
                     showLoading(false);
                     showError(error.message);
                     return;
                 }
                 
                 showLoading(false);
             }
             
             if (lat === null || lng === null) {
                 showError(ERROR_MESSAGES.NO_INPUT);
                 return;
             }
             
             displayResults(lat, lng, what3wordsUrl);
             
         } catch (error) {
             showError(error.message);
         }
     }

     // ===== RESULTS DISPLAY FUNCTIONS =====
     async function displayResults(lat, lng, what3wordsUrl = null) {
         const resultsDiv = document.getElementById('results');
         const mapSection = document.getElementById('map-section');
         const decimalCoords = `${lat.toFixed(CONFIG.COORDINATE_PRECISION)}, ${lng.toFixed(CONFIG.COORDINATE_PRECISION)}`;
         
         const shortLink = `https://www.google.com/maps?q=${lat.toFixed(CONFIG.COORDINATE_PRECISION)},${lng.toFixed(CONFIG.COORDINATE_PRECISION)}`;          
         let address = 'Looking up detailed address...';
         
         let combinedResults = `<div style="margin-bottom: 8px;"><strong>Coordinates:</strong></div>
<div style="margin-bottom: 8px;">${decimalCoords}</div>
<div style="margin-bottom: 4px;"><a href="${shortLink}" target="_blank">Open Coordinates in Google Maps</a></div>
<div style="margin-bottom: 12px; font-size: 12px; color: #888;">${shortLink}</div>`;
         
         if (what3wordsUrl) {
             combinedResults += `
<hr class="result-separator">

<div style="margin-bottom: 8px;"><strong>What3Words Location:</strong></div>
<div style="margin-bottom: 4px;"><a href="${what3wordsUrl}" target="_blank">Open on What3Words</a></div>
<div style="margin-bottom: 12px; font-size: 12px; color: #888;">${what3wordsUrl}</div>`;
         }
         
         combinedResults += `
<hr class="result-separator">

<div style="margin-bottom: 8px;"><strong>Address:</strong></div>
<div style="margin-bottom: 8px;">${address}</div>`;
         
         if (travelFromData) {
             const directionsLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(travelFromData)}&destination=${lat.toFixed(CONFIG.COORDINATE_PRECISION)},${lng.toFixed(CONFIG.COORDINATE_PRECISION)}`;
             combinedResults += `
<hr class="result-separator">

<div style="margin-bottom: 8px;"><strong>Directions from ${travelFromData}:</strong></div>
<div class="warning-text" style="margin-bottom: 8px; color: #dc3545; font-size: 13px; font-style: italic;">Navigation to destination may be inaccurate due to lack of roads, unsuitable roads, or routing. Please use as guide only and check all routing manually.</div>
<div style="margin-bottom: 4px;"><a href="${directionsLink}" target="_blank">Get Directions in Google Maps</a></div>
<div style="margin-bottom: 8px; font-size: 12px; color: #888;">${directionsLink}</div>`;
         }
         
         document.getElementById('combined-results').innerHTML = combinedResults;
         resultsDiv.style.display = 'block';
         
         displayMap(lat.toFixed(CONFIG.COORDINATE_PRECISION), lng.toFixed(CONFIG.COORDINATE_PRECISION));
         mapSection.style.display = 'block';
          
         let finalAddress = await tryMultipleGeocodingServices(lat, lng);
         
         if (finalAddress) {
             address = finalAddress;
         } else {
             address = ERROR_MESSAGES.ADDRESS_LOOKUP_FAILED;
         }
         
         combinedResults = `<div style="margin-bottom: 8px;"><strong>Coordinates:</strong></div>
<div style="margin-bottom: 8px;">${decimalCoords}</div>
<div style="margin-bottom: 4px;"><a href="${shortLink}" target="_blank">Open Coordinates in Google Maps</a></div>
<div style="margin-bottom: 12px; font-size: 12px; color: #888;">${shortLink}</div>`;
         
         if (what3wordsUrl) {
             combinedResults += `
<hr class="result-separator">

<div style="margin-bottom: 8px;"><strong>What3Words Location:</strong></div>
<div style="margin-bottom: 4px;"><a href="${what3wordsUrl}" target="_blank">Open on What3Words</a></div>
<div style="margin-bottom: 12px; font-size: 12px; color: #888;">${what3wordsUrl}</div>`;
         }
         
         combinedResults += `
<hr class="result-separator">

<div style="margin-bottom: 8px;"><strong>Address:</strong></div>
<div style="margin-bottom: 8px;">${address}</div>`;
         
         if (travelFromData) {
             const directionsLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(travelFromData)}&destination=${lat.toFixed(CONFIG.COORDINATE_PRECISION)},${lng.toFixed(CONFIG.COORDINATE_PRECISION)}`;
             combinedResults += `
<hr class="result-separator">

<div style="margin-bottom: 8px;"><strong>Directions from ${travelFromData}:</strong></div>
<div class="warning-text" style="margin-bottom: 8px; color: #dc3545; font-size: 13px; font-style: italic;">Navigation to destination may be inaccurate due to lack of roads, unsuitable roads, or routing. Please use as guide only and check all routing manually.</div>
<div style="margin-bottom: 4px;"><a href="${directionsLink}" target="_blank">Get Directions in Google Maps</a></div>
<div style="margin-bottom: 8px; font-size: 12px; color: #888;">${directionsLink}</div>`;
         }
         
         document.getElementById('combined-results').innerHTML = combinedResults;
     }

     function displayMap(lat, lng) {
         const mapFrame = document.getElementById('map-frame');
         const embedUrl = `https://www.google.com/maps?q=${lat},${lng}&hl=en&z=${CONFIG.MAP_ZOOM_LEVEL}&output=embed`;
         mapFrame.src = embedUrl;
         mapFrame.style.background = 'white';
     }

     // ===== GEOCODING SERVICES =====
     async function tryMultipleGeocodingServices(lat, lng) {
         const services = [
             async () => {
                 try {
                     const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&extratags=1`);
                     const data = await response.json();
                     
                     if (data && data.address) {
                         const addr = data.address;
                         const parts = [];
                         
                         if (addr.house_number) parts.push(addr.house_number);
                         if (addr.road) parts.push(addr.road);
                         else if (addr.pedestrian) parts.push(addr.pedestrian);
                         else if (addr.footway) parts.push(addr.footway);
                         
                         if (addr.suburb) parts.push(addr.suburb);
                         else if (addr.neighbourhood) parts.push(addr.neighbourhood);
                         else if (addr.city) parts.push(addr.city);
                         
                         if (addr.state) parts.push(addr.state);
                         if (addr.postcode) parts.push(addr.postcode);
                         
                         if (parts.length >= 2) {
                             return parts.join(', ');
                         }
                     }
                     return null;
                 } catch (error) {
                     return null;
                 }
             },
             
             async () => {
                 try {
                     const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
                     const data = await response.json();
                     
                     if (data) {
                         const parts = [];
                         
                         if (data.houseNumber) parts.push(data.houseNumber);
                         if (data.street) parts.push(data.street);
                         else if (data.road) parts.push(data.road);
                         
                         if (data.locality) parts.push(data.locality);
                         else if (data.city) parts.push(data.city);
                         
                         if (data.principalSubdivision) parts.push(data.principalSubdivision);
                         if (data.postcode) parts.push(data.postcode);
                         
                         if (parts.length >= 2) {
                             return parts.join(', ');
                         }
                     }
                     return null;
                 } catch (error) {
                     return null;
                 }
             }
         ];
         
         for (const service of services) {
             const result = await service();
             if (result && result.length > 20) {
                 return result;
             }
         }
         
         for (const service of services) {
             const result = await service();
             if (result) {
                 return result;
             }
         }
         
         return null;
     }

     // ===== COPY AND EMAIL FUNCTIONS =====
     function copyAllText() {
         const copyBtn = document.getElementById('copy-btn');
         
         try {
             const results = document.getElementById('combined-results');
             const textContent = results.innerText || results.textContent;
             
             navigator.clipboard.writeText(textContent).then(() => {
                 copyBtn.textContent = '✅ Copied!';
                 copyBtn.classList.add('copied');
                 
                 setTimeout(() => {
                     copyBtn.textContent = '📋 Copy All';
                     copyBtn.classList.remove('copied');
                 }, 2000);
             }).catch(() => {
                 copyBtn.textContent = '❌ ' + ERROR_MESSAGES.COPY_FAILED.split('.')[0];
                 setTimeout(() => {
                     copyBtn.textContent = '📋 Copy All';
                 }, 3000);
             });
         } catch (err) {
             copyBtn.textContent = '❌ ' + ERROR_MESSAGES.COPY_FAILED.split('.')[0];
             setTimeout(() => {
                 copyBtn.textContent = '📋 Copy All';
             }, 3000);
         }
     }

     function openEmail() {
         try {
             const results = document.getElementById('combined-results');
             let textContent = results.innerText || results.textContent;
             
             textContent = textContent.replace(
                 /Navigation to destination may be inaccurate due to lack of roads, unsuitable roads, or routing\. Please use as guide only and check all routing manually\./g, 
                 '*** IMPORTANT WARNING ***\nNavigation to destination may be inaccurate due to lack of roads, unsuitable roads, or routing. Please use as guide only and check all routing manually.\n*** IMPORTANT WARNING ***'
             );
             
             const formattedText = textContent
                 .replace(/Open Coordinates in Google Maps/g, 'Open Coordinates in Google Maps')
                 .replace(/Open on What3Words/g, 'Open on What3Words')
                 .replace(/Get Directions in Google Maps/g, 'Get Directions in Google Maps')
                 .replace(/Address:/g, '\nAddress:')
                 .replace(/What3Words Location:/g, '\nWhat3Words Location:')
                 .replace(/Directions from/g, '\nDirections from');
                 
             const emailBody = `${formattedText}

BalSECC`;
                     
             const subject = encodeURIComponent('GPS coordinates for case');
             const body = encodeURIComponent(emailBody);
             
             const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
             
             window.open(mailtoLink, '_self');
         } catch (err) {
             console.error('Failed to open email:', err);
             alert(ERROR_MESSAGES.EMAIL_FAILED);
         }
     }

     // ===== INITIALIZATION =====
     updateOption1Display();
     updateOption2Display();
     checkAndDisableFields();
 </script>
</body>
</html>